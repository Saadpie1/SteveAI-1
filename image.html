<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SteveAI â€“ Image Generator | Built by Ahmed & Saadpie</title>
  <link rel="icon" href="/assets/favicon.png" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <style>
    /* Global Reset */
    body { background: #0c0c0c; color: #e0e0e0; margin: 0; font-family: -apple-system, sans-serif; min-height: 100vh; display: flex; flex-direction: column; }
    
    /* Header & Navigation */
    header { background: #1a1a1a; padding: 0.8rem 1.5rem; border-bottom: 2px solid #00ffcc; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
    .logo-link { text-decoration: none; color: #00ffcc; display: flex; align-items: center; }
    .logo { height: 28px; margin-right: 8px; border-radius: 4px; }
    nav { display: flex; gap: 10px; }
    nav a { color: #e0e0e0; text-decoration: none; padding: 0.5rem 0.8rem; font-size: 0.85rem; border-radius: 4px; transition: 0.2s; }
    nav a.active { background: #222; color: #00ffcc; border-bottom: 2px solid #00ffcc; }
    nav a:hover { color: #ff00ff; }

    /* Main Studio Layout */
    main { max-width: 1200px; width: 95%; margin: 2rem auto; padding: 0 1rem; text-align: center; flex-grow: 1; }
    h1 { color: #00ffcc; font-size: 2.2rem; margin-bottom: 0.2rem; }
    .collab-tag { color: #ff00ff; font-weight: bold; font-size: 0.8rem; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 2rem; display: block; }

    /* Controls Container */
    .controls { background: #151515; padding: 2rem; border-radius: 16px; border: 1px solid #333; display: flex; flex-direction: column; gap: 1.2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    
    /* Image-to-Image Zone */
    .upload-zone { width: 100%; padding: 1.5rem; border: 2px dashed #444; border-radius: 12px; cursor: pointer; transition: 0.3s; display: flex; flex-direction: column; align-items: center; gap: 10px; color: #888; background: #111; position: relative; }
    .upload-zone:hover, .upload-zone.active { border-color: #ff00ff; color: #fff; background: #1a111a; }
    #imagePreview { max-height: 120px; border-radius: 8px; display: none; margin-bottom: 10px; border: 1px solid #ff00ff; }

    /* Inputs */
    input[type="text"] { width: 100%; padding: 1.2rem; border-radius: 10px; border: 1px solid #333; background: #222; color: #fff; font-size: 1.1rem; box-sizing: border-box; }
    input[type="text"]:focus { border-color: #00ffcc; outline: none; box-shadow: 0 0 10px rgba(0, 255, 204, 0.2); }
    
    .settings-row { display: flex; gap: 10px; width: 100%; justify-content: center; flex-wrap: wrap; }
    select { padding: 0.8rem 1rem; border-radius: 8px; border: 1px solid #333; background: #222; color: #fff; font-size: 0.9rem; cursor: pointer; min-width: 180px; }
    
    button#generateBtn { padding: 1.2rem 2rem; border-radius: 10px; background: #00ffcc; color: #000; font-weight: 800; border: none; cursor: pointer; transition: 0.3s; width: 100%; max-width: 400px; margin: 0 auto; box-shadow: 0 5px 15px rgba(0, 255, 204, 0.3); }
    button#generateBtn:hover:not(:disabled) { background: #ff00ff; color: #fff; transform: translateY(-2px); box-shadow: 0 8px 20px rgba(255, 0, 255, 0.4); }
    button#generateBtn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Results Grid */
    #result { margin-top: 3rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 2rem; }
    .img-container { background: #1a1a1a; padding: 1.2rem; border-radius: 16px; border: 1px solid #333; transition: 0.3s; }
    .img-container:hover { border-color: #00ffcc; transform: scale(1.02); }
    .img-container img { width: 100%; border-radius: 10px; margin-bottom: 1.2rem; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
    .img-actions { display: flex; justify-content: center; gap: 10px; }
    .download-btn { display: inline-block; padding: 10px 20px; background: transparent; color: #00ffcc; text-decoration: none; font-weight: bold; border-radius: 6px; border: 1px solid #00ffcc; transition: 0.2s; }
    .download-btn:hover { background: #00ffcc; color: #000; }
  </style>
</head>
<body>
  <header>
    <a href="/" class="logo-link">
        <img src="SteveAI-logo.jpg" alt="SteveAI" class="logo" /> 
        <h1>SteveAI <span style="font-size: 0.5em; color: #ff00ff; vertical-align: middle;">STUDIO</span></h1>
    </a>
    <nav>
      <a href="/">Home</a>
      <a href="/chat.html">Chat</a>
      <a href="/image.html" class="active">Image</a>
      <a href="/3d">3D</a>
    </nav>
  </header>

  <main>
    <h1>ðŸŽ¨ Ultra-HD Visual Arts</h1>
    <span class="collab-tag">Multi-Modal Orchestrator by Saadpie</span>
    
    <div class="controls">
        <div class="upload-zone" id="dropZone">
            <img id="imagePreview" alt="Preview" />
            <div id="uploadUI">
                <i class="fa-solid fa-wand-magic-sparkles" style="font-size: 1.5rem; color: #ff00ff;"></i>
                <p id="uploadText">Drop an image for <strong>Nano Banana Edit Mode</strong></p>
            </div>
            <input type="file" id="imageInput" hidden accept="image/*" />
        </div>

        <input type="text" id="prompt" placeholder="Describe a masterpiece or suggest edits for your photo..." />
        
        <div class="settings-row">
            <select id="modelSelect"></select>
            <select id="sizeSelect">
                <option value="square">1:1 Square</option>
                <option value="landscape">16:9 Landscape</option>
                <option value="portrait">9:16 Portrait</option>
                <option value="ultrawide">21:9 Cinematic</option>
                <option value="hd_square">2K Ultra HD</option>
            </select>
            <select id="numImagesSelect">
                <option value="1">1 Image</option>
                <option value="4">Batch Mode (4)</option>
            </select>
        </div>
        
        <button id="generateBtn">GENERATE MASTERPIECE</button>
    </div>
    
    <div id="result"></div>
  </main>

  <script type="module">
    import { generateImage, syncImageModels, IMAGE_MODELS } from './image.js'; 
    import { PUTER_IMAGE_MODELS } from './puter-image.js';

    const generateBtn = document.getElementById("generateBtn");
    const promptInput = document.getElementById("prompt");
    const resultDiv = document.getElementById("result");
    const modelSelect = document.getElementById("modelSelect");
    const sizeSelect = document.getElementById("sizeSelect");
    const imageInput = document.getElementById("imageInput");
    const dropZone = document.getElementById("dropZone");
    const imagePreview = document.getElementById("imagePreview");
    const uploadUI = document.getElementById("uploadUI");

    let base64Image = null;

    // --- Dynamic Sync & Categorization ---
    async function populateInterface() {
        try {
            await syncImageModels(); // Discovery from image.js
            modelSelect.innerHTML = "";

            // 1. Puter Priority Group
            const puterGroup = document.createElement('optgroup');
            puterGroup.label = "â”€â”€ PUTER UNLIMITED (Banana) â”€â”€";
            PUTER_IMAGE_MODELS.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m.id;
                opt.textContent = m.label;
                puterGroup.appendChild(opt);
            });
            modelSelect.appendChild(puterGroup);

            // 2. A4F Dynamic Group
            if (IMAGE_MODELS.length > 0) {
                const providers = [...new Set(IMAGE_MODELS.map(m => m.provider))];
                providers.forEach(p => {
                    const group = document.createElement('optgroup');
                    group.label = `â”€â”€ ${p.toUpperCase()} ENGINE â”€â”€`;
                    IMAGE_MODELS.filter(m => m.provider === p).forEach(model => {
                        const opt = document.createElement('option');
                        opt.value = model.id;
                        opt.textContent = model.name;
                        group.appendChild(opt);
                    });
                    modelSelect.appendChild(group);
                });
            }
        } catch (e) {
            console.error("Interface Population Failed:", e);
        }
    }

    // --- Interaction Logic ---
    dropZone.onclick = () => imageInput.click();
    
    imageInput.onchange = e => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (ex) => {
                base64Image = ex.target.result;
                imagePreview.src = base64Image;
                imagePreview.style.display = 'block';
                uploadUI.style.display = 'none';
                dropZone.classList.add('active');
            };
            reader.readAsDataURL(file);
        }
    };

    generateBtn.onclick = async () => {
      const prompt = promptInput.value.trim();
      if (!prompt) return alert("SteveAI needs a prompt to begin orchestration.");

      generateBtn.disabled = true;
      generateBtn.innerHTML = '<i class="fa-solid fa-atom fa-spin"></i> ORCHESTRATING...';
      resultDiv.innerHTML = `<p style="color:#00ffcc; width:100%;">Contacting Neural Nodes...</p>`;

      try {
        const response = await generateImage(
            prompt, 
            modelSelect.value, 
            base64Image, 
            sizeSelect.value, 
            parseInt(document.getElementById('numImagesSelect').value)
        ); 

        // âœ… SAFE-ARRAY LOGIC: Dissolves the "map of undefined" error
        const urls = Array.isArray(response) ? response : (response ? [response] : []);

        if (urls.length === 0) {
            throw new Error("Neural node returned no data. Try a different engine.");
        }

        resultDiv.innerHTML = urls.map((url, i) => `
            <div class="img-container">
                <img src="${url}" loading="lazy" onerror="this.src='placeholder.jpg'">
                <div class="img-actions">
                    <a href="${url}" target="_blank" class="download-btn"><i class="fa-solid fa-download"></i> HD DOWNLOAD</a>
                </div>
            </div>
        `).join('');

      } catch (err) {
        resultDiv.innerHTML = `<p style="color:#ff00ff;"><strong>SteveAI Engine Error:</strong> ${err.message}</p>`;
      } finally {
        generateBtn.disabled = false;
        generateBtn.textContent = "GENERATE MASTERPIECE";
      }
    };

    populateInterface();
  </script>
</body>
</html>
